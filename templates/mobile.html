<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‘å¸ƒçˆ†æ–‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .article-meta {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #666;
        }

        .article-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .article-content {
            font-size: 15px;
            color: #666;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .image-section {
            margin-bottom: 20px;
            text-align: center;
        }

        .image-preview {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .image-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            background: #f0f0f0;
            color: #666;
            cursor: pointer;
        }

        .btn-small:active {
            transform: scale(0.95);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #4caf50;
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¥ å‘å¸ƒçˆ†æ–‡</h1>
            <p>ä¸€é”®å‘å¸ƒåˆ°å†…å®¹åº“</p>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>åŠ è½½çˆ†æ–‡å†…å®¹...</p>
        </div>

        <div id="content" style="display: none;">
            <div class="success-message" id="success-message">
                âœ… å‘å¸ƒæˆåŠŸï¼
            </div>

            <div class="error-message" id="error-message">
                âŒ å‘å¸ƒå¤±è´¥
            </div>

            <!-- æ“ä½œæŒ‰é’®åŒº - ç§»åˆ°é¡¶éƒ¨ -->
            <div class="card">
                <h3 style="text-align: center; color: #333; margin-bottom: 16px; font-size: 18px;">
                    ğŸ¯ å¿«é€Ÿå‘å¸ƒ
                </h3>

                <button class="btn btn-primary" onclick="publishToXiaohongshuApp()">
                    ğŸ“± å”¤é†’å°çº¢ä¹¦APPå‘å¸ƒ
                </button>

                <button class="btn btn-secondary" onclick="publishToCompanyAPI()">
                    ğŸ¢ ä¿å­˜åˆ°å…¬å¸å†…å®¹åº“
                </button>

                <button class="btn btn-secondary" onclick="copyContent()">
                    ğŸ“‹ å¤åˆ¶å†…å®¹
                </button>

                <div style="margin-top: 16px; padding: 12px; background: #f0f7ff; border-radius: 8px; font-size: 12px; color: #666; line-height: 1.6;">
                    ğŸ’¡ <strong>æç¤ºï¼š</strong><br>
                    ğŸ“± å”¤é†’APPåï¼Œå†…å®¹å·²å¤åˆ¶ï¼Œç›´æ¥ç²˜è´´å‘å¸ƒ<br>
                    ğŸ¢ ä¿å­˜æˆåŠŸåï¼Œå¯åœ¨å…¬å¸ç³»ç»ŸæŸ¥çœ‹ç¬”è®°ID
                </div>
            </div>

            <!-- æ–‡ç« å†…å®¹åŒº -->
            <div class="card">
                <div class="article-meta" id="article-meta">
                    åŠ è½½ä¸­...
                </div>

                <div class="article-title" id="article-title">
                    åŠ è½½ä¸­...
                </div>

                <!-- é…å›¾åŒº -->
                <div class="image-section" id="image-section" style="display: none;">
                    <img id="article-image" class="image-preview" src="" alt="é…å›¾">
                    <div class="image-actions">
                        <button class="btn-small" onclick="downloadImage()">ğŸ“¥ ä¸‹è½½é…å›¾</button>
                        <button class="btn-small" onclick="copyImageLink()">ğŸ”— å¤åˆ¶å›¾ç‰‡é“¾æ¥</button>
                    </div>
                </div>

                <div class="article-content" id="article-content">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.host;
        let currentPost = null;

        // ä»URLè·å–æ–‡ç« IDå’Œæ—¥æœŸå‚æ•°
        const pathParts = window.location.pathname.split('/');
        const postId = parseInt(pathParts[pathParts.length - 1], 10);  // è½¬æ¢ä¸ºæ•´æ•°

        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date') || '';

        // åŠ è½½æ–‡ç« 
        async function loadPost() {
            try {
                // æ„å»ºAPI URLï¼Œå¦‚æœæœ‰æ—¥æœŸå‚æ•°åˆ™æ·»åŠ 
                let url = `${API_BASE}/api/posts/${postId}`;
                if (dateParam) {
                    url += `?date=${dateParam}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'success') {
                    currentPost = result.data;
                    displayPost(result.data);
                } else {
                    showError('åŠ è½½å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ–‡ç« 
        function displayPost(post) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            document.getElementById('article-meta').textContent =
                `#${post.id} | ${post.category} | ${post.title_type} | ${post.platform}`;

            document.getElementById('article-title').textContent = post.title;
            document.getElementById('article-content').textContent = post.content;

            // ç”Ÿæˆé…å›¾
            generateAndDisplayImage(post.title);
        }

        // ç”Ÿæˆå¹¶æ˜¾ç¤ºé…å›¾
        async function generateAndDisplayImage(title) {
            try {
                // è°ƒç”¨åç«¯ç”Ÿæˆå›¾ç‰‡
                const response = await fetch(`${API_BASE}/api/generate-image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title
                    })
                });

                const result = await response.json();

                if (result.status === 'success' && result.data.image_url) {
                    // æ˜¾ç¤ºå›¾ç‰‡
                    const imageSection = document.getElementById('image-section');
                    const articleImage = document.getElementById('article-image');

                    articleImage.src = result.data.image_url;
                    imageSection.style.display = 'block';

                    // ä¿å­˜å›¾ç‰‡URLä¾›ä¸‹è½½ä½¿ç”¨
                    window.currentImageUrl = result.data.image_url;
                }
            } catch (error) {
                console.log('å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', error);
                // å›¾ç‰‡ç”Ÿæˆå¤±è´¥ä¸å½±å“æ˜¾ç¤ºï¼Œåªæ˜¯ä¸æ˜¾ç¤ºå›¾ç‰‡åŒº
            }
        }

        // ä¸‹è½½é…å›¾
        function downloadImage() {
            if (!window.currentImageUrl) {
                alert('å›¾ç‰‡æœªåŠ è½½');
                return;
            }

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.href = window.currentImageUrl;
            link.download = `xiaohongshu_cover_${Date.now()}.png`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // å¤åˆ¶å›¾ç‰‡é“¾æ¥
        async function copyImageLink() {
            if (!window.currentImageUrl) {
                alert('å›¾ç‰‡æœªåŠ è½½');
                return;
            }

            try {
                await navigator.clipboard.writeText(window.currentImageUrl);
                alert('âœ… å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶ï¼');
            } catch (error) {
                // å¤‡ç”¨æ–¹æ³•
                const textarea = document.createElement('textarea');
                textarea.value = window.currentImageUrl;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('âœ… å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶ï¼');
                } catch (err) {
                    alert('âŒ å¤åˆ¶å¤±è´¥');
                }
                document.body.removeChild(textarea);
            }
        }

        // å”¤é†’å°çº¢ä¹¦APPå‘å¸ƒ
        async function publishToXiaohongshuApp() {
            if (!currentPost) {
                alert('å†…å®¹æœªåŠ è½½');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½ä¸­
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'â³ å‡†å¤‡ä¸­...';
            btn.disabled = true;

            try {
                // 1. å‡†å¤‡å¤åˆ¶å†…å®¹
                let content = `${currentPost.title}\n\n${currentPost.content}`;

                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡é“¾æ¥æç¤º
                if (window.currentImageUrl) {
                    content += `\n\nğŸ“¸ é…å›¾é“¾æ¥ï¼š${window.currentImageUrl}`;
                    window.currentImageUrlForApp = window.currentImageUrl;
                }

                // 2. å¤åˆ¶å†…å®¹åˆ°å‰ªè´´æ¿
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(content);
                } else {
                    fallbackCopy(content);
                }

                // 3. ä½¿ç”¨æ­£ç¡®çš„å°çº¢ä¹¦å‘å¸ƒScheme
                // å‚è€ƒå®˜æ–¹æ–¹æ¡ˆï¼šxhsdiscover://post ç›´æ¥æ‰“å¼€å‘å¸ƒé¡µé¢
                const publishScheme = 'xhsdiscover://post';

                document.getElementById('success-message').innerHTML =
                    `âœ… å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼<br><br>æ­£åœ¨æ‰“å¼€å°çº¢ä¹¦å‘å¸ƒé¡µé¢...`;
                document.getElementById('success-message').style.display = 'block';

                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿å¤åˆ¶å®Œæˆ
                setTimeout(() => {
                    // æ–¹æ³•1: ä½¿ç”¨window.locationç›´æ¥è·³è½¬
                    window.location.href = publishScheme;

                    // æ–¹æ³•2: ä½¿ç”¨iframeï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼ŒæŸäº›æµè§ˆå™¨æ›´æ”¯æŒï¼‰
                    setTimeout(() => {
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = publishScheme;
                        document.body.appendChild(iframe);

                        // 2ç§’åç§»é™¤iframe
                        setTimeout(() => {
                            if (iframe.parentNode) {
                                document.body.removeChild(iframe);
                            }
                        }, 2000);
                    }, 500);

                    // æ˜¾ç¤ºæ‰‹åŠ¨æ“ä½œæç¤ºï¼ˆä»¥é˜²APPæœªè‡ªåŠ¨æ‰“å¼€ï¼‰
                    setTimeout(() => {
                        let instructions = `âœ… å†…å®¹å·²å¤åˆ¶ï¼<br><br>
                            ğŸ“± <strong>å¦‚æœå°çº¢ä¹¦æ²¡æœ‰è‡ªåŠ¨æ‰“å¼€ï¼š</strong><br><br>
                            1ï¸âƒ£ æ‰‹åŠ¨æ‰“å¼€å°çº¢ä¹¦APP<br>
                            2ï¸âƒ£ ä¼šè‡ªåŠ¨è¿›å…¥å‘å¸ƒé¡µé¢<br>
                            3ï¸âƒ£ é•¿æŒ‰è¾“å…¥æ¡†ï¼Œé€‰æ‹©"ç²˜è´´"<br>
                            4ï¸âƒ£ ç‚¹å‡»å‘å¸ƒ<br><br>
                            ğŸ’¡ å†…å®¹å·²ç»å¤åˆ¶å¥½äº†ï¼Œç›´æ¥ç²˜è´´å³å¯ï¼`;

                        if (window.currentImageUrlForApp) {
                            instructions = `âœ… å†…å®¹å’Œå›¾ç‰‡é“¾æ¥å·²å¤åˆ¶ï¼<br><br>
                                ğŸ“± <strong>å¦‚æœå°çº¢ä¹¦æ²¡æœ‰è‡ªåŠ¨æ‰“å¼€ï¼š</strong><br><br>
                                1ï¸âƒ£ æ‰‹åŠ¨æ‰“å¼€å°çº¢ä¹¦APP<br>
                                2ï¸âƒ£ ä¼šè‡ªåŠ¨è¿›å…¥å‘å¸ƒé¡µé¢<br>
                                3ï¸âƒ£ é•¿æŒ‰è¾“å…¥æ¡†ï¼Œç²˜è´´æ–‡å­—å†…å®¹<br>
                                4ï¸âƒ£ ç‚¹å‡»"æ·»åŠ å›¾ç‰‡"ï¼Œä¸Šä¼ ä¸‹è½½çš„é…å›¾<br>
                                5ï¸âƒ£ ç‚¹å‡»å‘å¸ƒ<br><br>
                                ğŸ’¡ é…å›¾å¯ä»¥å…ˆç‚¹å‡»ä¸Šæ–¹"ä¸‹è½½é…å›¾"æŒ‰é’®ä¿å­˜ï¼`;
                        }

                        document.getElementById('success-message').innerHTML = instructions;
                    }, 2000);

                    setTimeout(() => {
                        document.getElementById('success-message').style.display = 'none';
                    }, 15000);

                }, 500);

            } catch (error) {
                document.getElementById('error-message').textContent = 'âŒ æ“ä½œå‡ºé”™: ' + error.message;
                document.getElementById('error-message').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('error-message').style.display = 'none';
                }, 5000);
            } finally {
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // ä¿å­˜åˆ°å…¬å¸APIï¼ˆé‡å‘½ååŸå‡½æ•°ï¼‰
        async function publishToCompanyAPI() {
            if (!currentPost) {
                alert('å†…å®¹æœªåŠ è½½');
                return;
            }

            if (!confirm('ç¡®è®¤ä¿å­˜åˆ°å…¬å¸å†…å®¹åº“å—ï¼Ÿ')) {
                return;
            }

            // æ˜¾ç¤ºåŠ è½½ä¸­
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'â³ ä¿å­˜ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/publish-to-company`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        post_id: postId,
                        date: dateParam,
                        generate_image: false
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    const noteId = result.data.company_response.data || 'å·²åˆ›å»º';
                    document.getElementById('success-message').innerHTML =
                        `âœ… ä¿å­˜æˆåŠŸï¼<br>ç¬”è®°ID: ${noteId}<br><br>ğŸ’¡ è¯·ç™»å½•å…¬å¸ç®¡ç†ç³»ç»ŸæŸ¥çœ‹å’Œå‘å¸ƒ`;
                    document.getElementById('success-message').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('success-message').style.display = 'none';
                    }, 8000);
                } else {
                    document.getElementById('error-message').textContent = 'âŒ ' + result.message;
                    document.getElementById('error-message').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('error-message').style.display = 'none';
                    }, 5000);
                }
            } catch (error) {
                document.getElementById('error-message').textContent = 'âŒ ä¿å­˜å‡ºé”™: ' + error.message;
                document.getElementById('error-message').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('error-message').style.display = 'none';
                }, 5000);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // å¤åˆ¶å†…å®¹
        function copyContent() {
            if (!currentPost) {
                alert('å†…å®¹æœªåŠ è½½');
                return;
            }

            const content = `${currentPost.title}\n\n${currentPost.content}`;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(content).then(() => {
                    alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nå¯ä»¥ç²˜è´´åˆ°å°çº¢ä¹¦å‘å¸ƒäº†ã€‚');
                }).catch(() => {
                    fallbackCopy(content);
                });
            } else {
                fallbackCopy(content);
            }
        }

        // å¤‡é€‰å¤åˆ¶æ–¹æ³•
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } catch (err) {
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            document.body.removeChild(textarea);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('loading').innerHTML = `<p>${message}</p>`;
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.onload = function() {
            loadPost();
        };
    </script>
</body>
</html>
